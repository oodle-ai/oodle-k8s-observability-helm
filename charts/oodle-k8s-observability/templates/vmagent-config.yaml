{{- if and .Values.vmagent.enabled .Values.vmagent.managedScrapeConfig.enabled }}
{{- include "oodle-k8s-observability.validateVmagentConfig" . }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vmagent-scrape-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "oodle-k8s-observability.labels" . | nindent 4 }}
  annotations:
    # Checksum of the scrape config content for tracking changes
    checksum/content: {{ include "oodle-k8s-observability.vmagentScrapeConfigChecksum" . }}
data:
  scrape.yml: |
    {{- include "oodle-k8s-observability.vmagentScrapeConfigContent" . | nindent 4 }}
---
# ConfigMap containing the scrape config checksum
# This is referenced by vmagent pods via an environment variable
# When the checksum changes, the env var value changes, triggering a pod restart
apiVersion: v1
kind: ConfigMap
metadata:
  name: vmagent-scrape-config-checksum
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "oodle-k8s-observability.labels" . | nindent 4 }}
data:
  checksum: {{ include "oodle-k8s-observability.vmagentScrapeConfigChecksum" . | quote }}
{{- end }}
